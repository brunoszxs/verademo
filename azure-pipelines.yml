trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  VERACODE_API_KEY_ID: $(VeracodeApiId)
  VERACODE_API_KEY_SECRET: $(VeracodeApiKey)

steps:
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    codeCoverageToolOption: 'JaCoCo'
    options: '-DskipTests=true -Dmaven.javadoc.skip=true'

- task: CopyFiles@2
  inputs:
    SourceFolder: '$(System.DefaultWorkingDirectory)/target'
    Contents: '**/*.jar'
    TargetFolder: '$(Build.ArtifactStagingDirectory)/jars'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/jars'
    ArtifactName: 'jars'
    publishLocation: 'Container'

- task: Veracode@3
  inputs:
    ConnectionDetailsSelection: 'Service Connection'
    AnalysisService: 'VeracodeServiceConnection'
    veracodeAppProfile: 'YourAppName'
    version: '$(Build.BuildNumber)'
    filepath: '$(Build.ArtifactStagingDirectory)/jars'
    optargs: '-criticality high -createsandbox true -sandboxname mysandbox'
    createSandBox: true
    createProfile: true
    failBuildIfUploadAndScanBuildStepFails: true
    importResults: true
    failBuildOnPolicyFail: true
    maximumWaitTime: '360'